{"version":3,"file":"PackageMetadataManager.test.js","sourceRoot":"","sources":["../../../src/analyzer/test/PackageMetadataManager.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\nimport { PackageMetadataManager } from '../PackageMetadataManager';\nimport {\n  FileSystem,\n  PackageJsonLookup,\n  type INodePackageJson,\n  NewlineKind\n} from '@rushstack/node-core-library';\n\nconst packageJsonLookup: PackageJsonLookup = new PackageJsonLookup();\n\nfunction resolveInTestPackage(testPackageName: string, ...args: string[]): string {\n  return path.resolve(__dirname, 'test-data/tsdoc-metadata-path-inference', testPackageName, ...args);\n}\n\nfunction getPackageMetadata(testPackageName: string): {\n  packageFolder: string;\n  packageJson: INodePackageJson;\n} {\n  const packageFolder: string = resolveInTestPackage(testPackageName);\n  const packageJson: INodePackageJson | undefined = packageJsonLookup.tryLoadPackageJsonFor(packageFolder);\n  if (!packageJson) {\n    throw new Error('There should be a package.json file in the test package');\n  }\n  return { packageFolder, packageJson };\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction firstArgument(mockFn: jest.Mock): any {\n  return mockFn.mock.calls[0][0];\n}\n\n/* eslint-disable @typescript-eslint/typedef */\n\ndescribe(PackageMetadataManager.name, () => {\n  describe(PackageMetadataManager.writeTsdocMetadataFile.name, () => {\n    const originalWriteFile = FileSystem.writeFile;\n    const mockWriteFile: jest.Mock = jest.fn();\n    beforeAll(() => {\n      FileSystem.writeFile = mockWriteFile;\n    });\n    afterEach(() => {\n      mockWriteFile.mockClear();\n    });\n    afterAll(() => {\n      FileSystem.writeFile = originalWriteFile;\n    });\n\n    it('writes the tsdoc metadata file at the provided path', () => {\n      PackageMetadataManager.writeTsdocMetadataFile('/foo/bar', NewlineKind.CrLf);\n      expect(firstArgument(mockWriteFile)).toBe('/foo/bar');\n    });\n  });\n\n  describe(PackageMetadataManager.resolveTsdocMetadataPath.name, () => {\n    describe('when an empty tsdocMetadataPath is provided', () => {\n      const tsdocMetadataPath: string = '';\n      describe('given a package.json where the field \"tsdocMetadata\" is defined', () => {\n        it('outputs the tsdoc metadata path as given by \"tsdocMetadata\" relative to the folder of package.json', () => {\n          const { packageFolder, packageJson } = getPackageMetadata('package-inferred-from-tsdoc-metadata');\n          expect(\n            PackageMetadataManager.resolveTsdocMetadataPath(packageFolder, packageJson, tsdocMetadataPath)\n          ).toBe(path.resolve(packageFolder, packageJson.tsdocMetadata as string));\n        });\n      });\n      describe('given a package.json where the field \"typings\" is defined and \"tsdocMetadata\" is not defined', () => {\n        it('outputs the tsdoc metadata file \"tsdoc-metadata.json\" in the same folder as the path of \"typings\"', () => {\n          const { packageFolder, packageJson } = getPackageMetadata('package-inferred-from-typings');\n          expect(\n            PackageMetadataManager.resolveTsdocMetadataPath(packageFolder, packageJson, tsdocMetadataPath)\n          ).toBe(path.resolve(packageFolder, path.dirname(packageJson.typings!), 'tsdoc-metadata.json'));\n        });\n      });\n      describe('given a package.json where the field \"main\" is defined but not \"typings\" nor \"tsdocMetadata\"', () => {\n        it('outputs the tsdoc metadata file \"tsdoc-metadata.json\" in the same folder as the path of \"main\"', () => {\n          const { packageFolder, packageJson } = getPackageMetadata('package-inferred-from-main');\n          expect(\n            PackageMetadataManager.resolveTsdocMetadataPath(packageFolder, packageJson, tsdocMetadataPath)\n          ).toBe(path.resolve(packageFolder, path.dirname(packageJson.main!), 'tsdoc-metadata.json'));\n        });\n      });\n      describe('given a package.json where the fields \"main\", \"typings\" and \"tsdocMetadata\" are not defined', () => {\n        it('outputs the tsdoc metadata file \"tsdoc-metadata.json\" in the folder where package.json is located', () => {\n          const { packageFolder, packageJson } = getPackageMetadata('package-default');\n          expect(\n            PackageMetadataManager.resolveTsdocMetadataPath(packageFolder, packageJson, tsdocMetadataPath)\n          ).toBe(path.resolve(packageFolder, 'tsdoc-metadata.json'));\n        });\n      });\n    });\n    describe('when a non-empty tsdocMetadataPath is provided', () => {\n      const tsdocMetadataPath: string = 'path/to/custom-tsdoc-metadata.json';\n      describe('given a package.json where the field \"tsdocMetadata\" is defined', () => {\n        it('outputs the tsdoc metadata file at the provided path in the folder where package.json is located', () => {\n          const { packageFolder, packageJson } = getPackageMetadata('package-inferred-from-tsdocMetadata');\n          expect(\n            PackageMetadataManager.resolveTsdocMetadataPath(packageFolder, packageJson, tsdocMetadataPath)\n          ).toBe(path.resolve(packageFolder, tsdocMetadataPath));\n        });\n      });\n      describe('given a package.json where the field \"typings\" is defined and \"tsdocMetadata\" is not defined', () => {\n        it('outputs the tsdoc metadata file at the provided path in the folder where package.json is located', () => {\n          const { packageFolder, packageJson } = getPackageMetadata('package-inferred-from-typings');\n          expect(\n            PackageMetadataManager.resolveTsdocMetadataPath(packageFolder, packageJson, tsdocMetadataPath)\n          ).toBe(path.resolve(packageFolder, tsdocMetadataPath));\n        });\n      });\n      describe('given a package.json where the field \"main\" is defined but not \"typings\" nor \"tsdocMetadata\"', () => {\n        it('outputs the tsdoc metadata file at the provided path in the folder where package.json is located', () => {\n          const { packageFolder, packageJson } = getPackageMetadata('package-inferred-from-main');\n          expect(\n            PackageMetadataManager.resolveTsdocMetadataPath(packageFolder, packageJson, tsdocMetadataPath)\n          ).toBe(path.resolve(packageFolder, tsdocMetadataPath));\n        });\n      });\n      describe('given a package.json where the fields \"main\", \"typings\" and \"tsdocMetadata\" are not defined', () => {\n        it('outputs the tsdoc metadata file at the provided path in the folder where package.json is located', () => {\n          const { packageFolder, packageJson } = getPackageMetadata('package-default');\n          expect(\n            PackageMetadataManager.resolveTsdocMetadataPath(packageFolder, packageJson, tsdocMetadataPath)\n          ).toBe(path.resolve(packageFolder, tsdocMetadataPath));\n        });\n      });\n    });\n  });\n});\n\n/* eslint-enable @typescript-eslint/typedef */\n"]}